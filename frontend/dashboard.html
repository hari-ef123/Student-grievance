<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Student Grievance System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/config.js"></script>
</head>

<body>
    <div class="navbar glass-card" style="position: absolute; top: 0; width: 95%; margin: 20px;">
        <div class="logo"><i class="fas fa-user-graduate"></i> Student Dashboard</div>
        <div style="display: flex; align-items: center;">
            <a href="index.html" class="btn btn-outline"
                style="padding: 5px 15px; font-size: 0.9rem; margin-right: 15px; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-home"></i> Home
            </a>
            <button onclick="window.location.reload()" class="btn btn-outline"
                style="padding: 5px 10px; font-size: 0.9rem; margin-right: 15px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;"
                title="Refresh Page">
                <i class="fas fa-sync-alt"></i>
            </button>
            <span style="margin-right: 15px;">Welcome, User!</span>
            <a href="#" onclick="return handleLogout(event)" class="btn btn-outline"
                style="padding: 5px 15px; font-size: 0.9rem;">Logout</a>
        </div>
    </div>

    <div class="container animate-fade-in" style="margin-top: 100px;">
        <!-- Stats Row -->
        <div class="grid-container">
            <div class="glass-card text-center">
                <i class="fas fa-file-alt fa-2x" style="color: #667eea; margin-bottom: 10px;"></i>
                <h3>Total Complaints</h3>
                <h2 id="total-count">0</h2>
            </div>
            <div class="glass-card text-center">
                <i class="fas fa-clock fa-2x" style="color: #f39c12; margin-bottom: 10px;"></i>
                <h3>Pending</h3>
                <h2 id="pending-count">0</h2>
            </div>
            <div class="glass-card text-center">
                <i class="fas fa-check-circle fa-2x" style="color: #2ecc71; margin-bottom: 10px;"></i>
                <h3>Resolved</h3>
                <h2 id="resolved-count">0</h2>
            </div>
        </div>

        <!-- Actions Row -->
        <div style="margin-top: 30px; display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="glass-card" style="flex: 1; min-width: 300px;">
                <h3><i class="fas fa-bullhorn"></i> Raise a New Complaint</h3>
                <p style="margin: 15px 0; opacity: 0.8;">Facing an issue? Submit your grievance here. We ensure privacy
                    and quick resolution.</p>
                <a href="complaint.html" class="btn btn-primary">File Complaint</a>
            </div>
            <div class="glass-card" style="flex: 1; min-width: 300px;">
                <h3><i class="fas fa-history"></i> Track Status</h3>
                <p style="margin: 15px 0; opacity: 0.8;">Check the real-time status of your submitted complaints with
                    admin remarks.</p>
                <a href="status.html" class="btn btn-outline" style="background: rgba(255,255,255,0.1);">View Status</a>
            </div>
        </div>

        <!-- Recent Activity (Placeholder for AJAX) -->
        <div class="glass-card" style="margin-top: 20px;">
            <h3>Recent Activity</h3>
            <div id="recent-activity-list" style="margin-top: 15px;">
                <p style="opacity: 0.7;">Loading data...</p>
            </div>
        </div>
    </div>

    <!-- Custom Popup Structure -->
    <div id="statusPopup" class="popup-overlay">
        <div class="popup-card">
            <div id="popupIconContainer" class="checkmark-container">
                <i id="popupIcon" class="fas fa-check"></i>
            </div>
            <h2 id="popupTitle">Success!</h2>
            <p id="popupMessage">Operation completed successfully.</p>
        </div>
    </div>

    <script>
        function showStatusPopup(title, message, type = 'success', redirectUrl = null) {
            const popup = document.getElementById('statusPopup');
            const iconContainer = document.getElementById('popupIconContainer');
            const icon = document.getElementById('popupIcon');

            document.getElementById('popupTitle').innerText = title;
            document.getElementById('popupMessage').innerText = message;

            if (type === 'error') {
                iconContainer.style.background = 'rgba(255, 107, 107, 0.2)';
                iconContainer.style.color = '#ff6b6b';
                icon.className = 'fas fa-times';
            } else {
                iconContainer.style.background = 'rgba(46, 204, 113, 0.2)';
                iconContainer.style.color = '#2ecc71';
                icon.className = 'fas fa-check';
            }

            popup.classList.add('active');

            if (redirectUrl) {
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 2000);
            } else {
                setTimeout(() => {
                    popup.classList.remove('active');
                }, 2500);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const userName = localStorage.getItem('user_name');

            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Update user name
            if (userName) {
                document.querySelector('.navbar span').textContent = `Welcome, ${userName}!`;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/complaints/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    showStatusPopup('Session Expired', 'Please login again.', 'error', 'login.html');
                    return;
                }

                if (!response.ok) throw new Error('Failed to fetch data');

                const complaints = await response.json();
                updateDashboard(complaints);

            } catch (err) {
                console.error('Error fetching dashboard data:', err);
                document.getElementById('recent-activity-list').innerHTML = '<p style="color: #ff6b6b">Failed to load data. Ensure backend is running.</p>';
            }
        });

        function updateDashboard(complaints) {
            // Calculate stats
            const total = complaints.length;
            const pending = complaints.filter(c => c.status === 'Pending' || c.status === 'In Progress').length;
            const resolved = complaints.filter(c => c.status === 'Resolved').length;

            document.getElementById('total-count').innerText = total;
            document.getElementById('pending-count').innerText = pending;
            document.getElementById('resolved-count').innerText = resolved;

            // Recent Activity 
            const activityList = document.getElementById('recent-activity-list');
            activityList.innerHTML = '';

            if (complaints.length === 0) {
                activityList.innerHTML = '<p style="opacity: 0.7;">No complaints found. Start by filing one!</p>';
                return;
            }

            // Show last 3
            complaints.slice().reverse().slice(0, 3).forEach(item => {
                activityList.innerHTML += `
                    <div style="border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 0;">
                        <strong>${item.category}</strong>: ${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}
                        <span class="status-badge status-${item.status.toLowerCase().replace(' ', '-')}" style="font-size: 0.7rem; margin-left:10px;">${item.status}</span>
                        <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">${new Date(item.created_at).toLocaleDateString()}</div>
                    </div>
                `;
            });
        }

        function handleLogout(event) {
            event.preventDefault();
            logout();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('user_name');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>